<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physicians - Medical DB</title>

  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/smart-search.css">
</head>
<body>

  <!-- NAVBAR -->
  <%- include("partials/navbar", { activePage: "physicians" }) %>


  <div class="container">

    <!-- HEADER -->
    <div class="page-header">
      <h2>Physicians</h2>
      <div>
        <a href="/" class="btn btn-secondary">Back Home</a>
      </div>
    </div>

    <!-- SEARCH + FILTER BAR -->
    <div class="searchbar-wrapper">
      <form id="filter-form" method="GET" class="searchbar-modern">

        <!-- MAIN SEARCH -->
        <input
          type="text"
          name="search"
          class="searchbar-main"
          placeholder="Search physicians..."
          value="<%= search %>"
          autocomplete="off"
        >

        <!-- SPECIALIZATION -->
        <select name="specialization" class="bubble">
          <option value="">Specialization</option>
          <% allSpecs.forEach(spec => { %>
            <option value="<%= spec %>" <%= specialization === spec ? "selected" : "" %>>
              <%= spec %>
            </option>
          <% }) %>
        </select>

        <input type="hidden" name="sort" id="sort-hidden" value="<%= sort %>">
        <input type="hidden" name="order" id="order-hidden" value="<%= order %>">

        <button type="submit" class="btn-apply bubble">Apply</button>

      </form>
    </div>


    <!-- NO RESULTS -->
    <% if (physicians.length === 0) { %>
      <div class="no-data">
        <p>No physicians found.</p>
      </div>
    <% } else { %>

      <!-- TABLE -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>
                <button type="button" class="table-sort <%= sort === 'name' ? 'active ' + order : '' %>" data-sort="name">
                  Name <span class="arrow">▲</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'specialization' ? 'active ' + order : '' %>" data-sort="specialization">
                  Specialization <span class="arrow">▲</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'email' ? 'active ' + order : '' %>" data-sort="email">
                  Email <span class="arrow">▲</span>
                </button>
              </th>
              <th>Phone</th>
              <th>Schedule</th>
            </tr>
          </thead>

          <!-- AJAX WILL UPDATE THIS -->
          <tbody id="physicians-table-body">
            <% physicians.forEach(doc => { %>
              <%- include("partials/physician-row", { physician: doc }) %>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <div id="pagination-container">
        <%- renderPagination(req, "/physicians", page, totalPages) %>
      </div>

      <!-- COUNT INDICATOR -->
      <p class="record-count" id="result-count">
        Showing <%= physicians.length %> of <%= totalCount %> physician<%= totalCount !== 1 ? "s" : "" %>
      </p>

    <% } %>

  </div>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>

  <script src="/js/table-ajax.js"></script>
  <script>
    // Column sorting (works with AJAX form)
    const sortButtons = document.querySelectorAll(".table-sort");
    const sortHidden = document.getElementById("sort-hidden");
    const orderHidden = document.getElementById("order-hidden");
    const filterForm = document.getElementById("filter-form");

    function applySortState() {
      sortButtons.forEach(btn => {
        const active = btn.dataset.sort === sortHidden.value;
        btn.classList.toggle("active", active);
        btn.classList.toggle("asc", active && orderHidden.value === "asc");
        btn.classList.toggle("desc", active && orderHidden.value === "desc");
      });
    }
    applySortState();

    sortButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const field = btn.dataset.sort;
        if (sortHidden.value === field) {
          orderHidden.value = orderHidden.value === "asc" ? "desc" : "asc";
        } else {
          sortHidden.value = field;
          orderHidden.value = field === "name" ? "asc" : "desc";
        }
        applySortState();
        filterForm.dispatchEvent(new Event("change", { bubbles: true }));
      });
    });
  </script>

  <style>
    .table-sort {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 700;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover { text-decoration: underline; }
    .table-sort.active .arrow { opacity: 1; }
    .table-sort.active.desc .arrow { transform: rotate(180deg); }
  </style>

</body>
</html>
