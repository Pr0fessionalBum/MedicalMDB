<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - Medical DB</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/smart-search.css">
</head>

<body>

  <!-- NAVBAR -->
  <%- include("partials/navbar", { activePage: "patients" }) %>

  <div class="container">

    <!-- HEADER -->
    <div class="page-header">
      <h2>Patients</h2>
      <div>
        <a href="/patients/create" class="btn btn-primary">+ Add Patient</a>
        <a href="/" class="btn btn-secondary">Back Home</a>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="searchbar-wrapper">

  <form id="filter-form" class="searchbar-modern" method="GET">

    <!-- Search field -->
    <input 
      type="text"
      name="search"
      placeholder="Search patients..."
      value="<%= search %>"
      autocomplete="off"
      class="searchbar-main"
    >

    <!-- Bubbly filters -->
    <select name="gender" class="bubble">
      <option value="">Gender</option>
      <option value="male"   <%= gender === "male" ? "selected" : "" %>>Male</option>
      <option value="female" <%= gender === "female" ? "selected" : "" %>>Female</option>
      <option value="other"  <%= gender === "other" ? "selected" : "" %>>Other</option>
    </select>

    <input type="number" name="ageMin" placeholder="Min Age" value="<%= ageMin %>" class="bubble">
    <input type="number" name="ageMax" placeholder="Max Age" value="<%= ageMax %>" class="bubble">

    <input type="hidden" name="sort" id="sort-hidden" value="<%= sort %>">
    <input type="hidden" name="order" id="order-hidden" value="<%= order %>">

    <button type="submit" class="bubble btn-apply">Apply</button>

  </form>

</div>


    <!-- NO DATA -->
    <% if (patients.length === 0) { %>
      <div class="no-data">
        <p>No patients found. <%= search ? "Try a different search term." : "Start by adding a new patient." %></p>
      </div>
    <% } else { %>

      <!-- TABLE -->
      <div id="patients-table-wrapper" class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>
                <button type="button" class="table-sort <%= sort === 'name' ? 'active ' + order : '' %>" data-sort="name">
                  Name <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'dob' ? 'active ' + order : '' %>" data-sort="dob">
                  DOB <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'age' ? 'active ' + order : '' %>" data-sort="age">
                  Age <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>Gender</th>
              <th>
                <button type="button" class="table-sort <%= sort === 'email' ? 'active ' + order : '' %>" data-sort="email">
                  Email <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="patients-table-body">
            <%- include("partials/patient-row", { patients }) %>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION OUTPUT (AJAX TARGET) -->
      <div id="pagination-container">
        <%- renderPagination(req, "/patients", page, totalPages) %>
      </div>

      <!-- RECORD COUNT -->
      <p class="record-count" id="result-count">
        Showing <%= patients.length %> of <%= totalCount %> patients
      </p>

    <% } %>

  </div>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>

  <!-- AJAX FILTER SCRIPT -->
  <script>
    const filterForm = document.getElementById('filter-form');
    const tableBody = document.getElementById('patients-table-body');
    const paginationContainer = document.getElementById('pagination-container');
    const resultCount = document.getElementById('result-count');

    let ajaxTimeout;
    function fetchPatients() {
      clearTimeout(ajaxTimeout);
      ajaxTimeout = setTimeout(() => {
        const params = new URLSearchParams(new FormData(filterForm)).toString();
        fetch(`/patients?${params}&ajax=1`)
          .then(res => res.json())
          .then(data => {
            tableBody.innerHTML = data.rowsHtml;
            paginationContainer.innerHTML = data.paginationHtml;
            resultCount.textContent = `Showing ${data.count} of ${data.totalCount} patients`;
          });
      }, 200);
    }

    filterForm.addEventListener('input', fetchPatients);
    filterForm.addEventListener('change', (e) => {
      e.preventDefault();
      fetchPatients();
    });

    // column sorting
    const sortButtons = document.querySelectorAll(".table-sort");
    const sortHidden = document.getElementById("sort-hidden");
    const orderHidden = document.getElementById("order-hidden");
    function applySortState() {
      sortButtons.forEach(btn => {
        const active = btn.dataset.sort === sortHidden.value;
        btn.classList.toggle("active", active);
        btn.classList.toggle("asc", active && orderHidden.value === "asc");
        btn.classList.toggle("desc", active && orderHidden.value === "desc");
      });
    }
    applySortState();

    sortButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const field = btn.dataset.sort;
        if (sortHidden.value === field) {
          orderHidden.value = orderHidden.value === "asc" ? "desc" : "asc";
        } else {
          sortHidden.value = field;
          orderHidden.value = field === "name" ? "asc" : "desc";
        }
        applySortState();
        fetchPatients();
      });
    });
  </script>

  <style>
    .table-sort {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 700;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover { text-decoration: underline; }
    .table-sort.active .arrow { opacity: 1; }
    .table-sort.active.desc .arrow { transform: rotate(180deg); }
  </style>

</body>
</html>
