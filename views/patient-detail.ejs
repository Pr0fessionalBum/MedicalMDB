<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= patient.name %> - Medical DB</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

  <%- include("partials/navbar", { activePage: "patients" }) %>

  <div class="container">
    <div class="page-header">
      <h2><%= patient.name %></h2>
      <a href="/patients" class="btn btn-secondary">Back to Patients</a>
    </div>

    <div class="detail-grid">
      <div class="detail-section">
        <h3>Patient Information</h3>
        <div class="info-card">
          <div class="info-row"><span class="label">Name:</span><span class="value"><%= patient.name %></span></div>
          <div class="info-row"><span class="label">Date of Birth:</span><span class="value"><%= new Date(patient.dob).toLocaleDateString() %></span></div>
          <div class="info-row"><span class="label">Age:</span><span class="value"><%= patient.age %> years old</span></div>
          <div class="info-row"><span class="label">Gender:</span><span class="value"><%= patient.gender %></span></div>
          <div class="info-row"><span class="label">Email:</span><span class="value"><%= patient.contactInfo?.email || 'N/A' %></span></div>
          <div class="info-row"><span class="label">Phone:</span><span class="value"><%= patient.contactInfo?.phone || 'N/A' %></span></div>
          <div class="info-row"><span class="label">Address:</span><span class="value"><%= patient.contactInfo?.address || 'N/A' %></span></div>
        </div>
      </div>
    </div>

    <div class="section-grid">
      <div class="section">
        <h3>Prescriptions (<%= prescriptions.length %>)</h3>
        <% if (prescriptions.length === 0) { %>
          <p class="no-data-text">No prescriptions found.</p>
        <% } else { %>
          <div class="table-wrapper">
            <table class="data-table sortable-table">
              <thead>
                <tr>
                  <th><button class="table-sort" data-col="0" data-type="text">Medication <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="1" data-type="text">Dosage <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="2" data-type="text">Frequency <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="3" data-type="text">Status <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="4" data-type="date">Start Date <span class="arrow">&#9650;</span></button></th>
                  <th>Physician</th>
                </tr>
              </thead>
              <tbody>
                <% prescriptions.forEach(rx => { %>
                  <tr>
                    <td><%= rx.medicationName %></td>
                    <td><%= rx.dosage %></td>
                    <td><%= rx.frequency || 'N/A' %></td>
                    <td><span class="badge badge-<%= rx.status %>"><%= rx.status %></span></td>
                    <td><%= new Date(rx.startDate).toLocaleDateString() %></td>
                    <td><%= rx.physicianID?.name || "N/A" %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <div class="section">
        <h3>Appointments (<%= appointments.length %>)</h3>
        <% if (appointments.length === 0) { %>
          <p class="no-data-text">No appointments found.</p>
        <% } else { %>
          <div class="table-wrapper">
            <table class="data-table sortable-table">
              <thead>
                <tr>
                  <th><button class="table-sort" data-col="0" data-type="date">Date <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="1" data-type="text">Summary <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="2" data-type="text">Diagnoses <span class="arrow">&#9650;</span></button></th>
                  <th>Physician</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% appointments.forEach(appt => { %>
                  <tr>
                    <td><%= new Date(appt.date).toLocaleDateString() %></td>
                    <td><%= appt.summary %></td>
                    <td>
                      <% if (appt.diagnoses && appt.diagnoses.length > 0) { %>
                        <%= appt.diagnoses.map(d => d.description).join(', ') %>
                      <% } else { %>
                        N/A
                      <% } %>
                    </td>
                    <td><%= appt.physicianID?.name || "N/A" %></td>
                    <td><a class="btn btn-small btn-ghost" href="/appointments/<%= appt._id %>">View</a></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>

      <div class="section">
        <h3>Billing Records (<%= billings.length %>)</h3>
        <% if (billings.length === 0) { %>
          <p class="no-data-text">No billing records found.</p>
        <% } else { %>
          <div class="table-wrapper">
            <table class="data-table sortable-table">
              <thead>
                <tr>
                  <th><button class="table-sort" data-col="0" data-type="number">Amount <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="1" data-type="text">Status <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="2" data-type="date">Created <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="3" data-type="date">Payment Date <span class="arrow">&#9650;</span></button></th>
                  <th><button class="table-sort" data-col="4" data-type="text">Insurance <span class="arrow">&#9650;</span></button></th>
                </tr>
              </thead>
              <tbody>
                <% billings.forEach(bill => { %>
                  <tr>
                    <td>$<%= bill.amount %></td>
                    <td><span class="badge badge-<%= bill.status %>"><%= bill.status %></span></td>
                    <td><%= new Date(bill.createdAt).toLocaleDateString() %></td>
                    <td><%= bill.paymentDate ? new Date(bill.paymentDate).toLocaleDateString() : 'N/A' %></td>
                    <td><%= bill.InsuranceProvider || 'N/A' %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>

  <script>
    // Client-side sorting for tables on detail page
    document.querySelectorAll(".sortable-table").forEach(table => {
      const headers = table.querySelectorAll(".table-sort");
      headers.forEach((btn) => {
        btn.addEventListener("click", () => {
          const col = Number(btn.dataset.col);
          const type = btn.dataset.type || "text";
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const isDesc = btn.classList.contains("active") && btn.classList.contains("desc");
          headers.forEach(h => h.classList.remove("active", "asc", "desc"));
          btn.classList.add("active", isDesc ? "asc" : "desc");
          const dir = isDesc ? 1 : -1;

          const sorted = rows.sort((a, b) => {
            const av = (a.children[col]?.innerText || "").trim();
            const bv = (b.children[col]?.innerText || "").trim();
            if (type === "number") return dir * ((parseFloat(bv) || 0) - (parseFloat(av) || 0));
            if (type === "date") return dir * ((Date.parse(bv) || 0) - (Date.parse(av) || 0));
            return dir * bv.localeCompare(av);
          });
          tbody.innerHTML = "";
          sorted.forEach(r => tbody.appendChild(r));
        });
      });
    });
  </script>

  <style>
    .table-sort {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 700;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover { text-decoration: underline; }
    .table-sort.active .arrow { opacity: 1; }
    .table-sort.active.desc .arrow { transform: rotate(180deg); }
  </style>

</body>
</html>
