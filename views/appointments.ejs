<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appointments - Medical DB</title>

  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/smart-search.css">
</head>
<body>

  <!-- NAVBAR -->
  <%- include("partials/navbar", { activePage: "appointments" }) %>

  <div class="container">

    <% 
      function sortUrl(field) {
        const params = new URLSearchParams();
        if (search) params.set("search", search);
        if (diagnosis) params.set("diagnosis", diagnosis);
        params.set("limit", limit);
        params.set("page", 1);
        params.set("sort", field);
        const nextOrder = (sort === field && order === "asc") ? "desc" : "asc";
        params.set("order", nextOrder);
        return `/appointments?${params.toString()}`;
      }
    %>

    <!-- PAGE HEADER -->
    <div class="page-header">
      <h2>Appointments</h2>
      <div>
        <a href="/appointments/create" class="btn btn-primary">+ Add Appointment</a>
        <a href="/" class="btn btn-secondary">Back Home</a>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="searchbar-wrapper">
      <form id="filter-form" class="searchbar-modern" method="GET">

        <input
          type="text"
          name="search"
          placeholder="Search appointments..."
          value="<%= search %>"
          autocomplete="off"
          class="searchbar-main"
        >

        <select name="diagnosis" class="bubble">
          <option value="">Diagnosis Code</option>
          <% (diagnosisOptions || []).filter(Boolean).forEach(code => { %>
            <option value="<%= code %>" <%= diagnosis === code ? "selected" : "" %>><%= code %></option>
          <% }) %>
        </select>

        <input type="hidden" name="sort" id="sort-hidden" value="<%= sort %>">
        <input type="hidden" name="order" id="order-hidden" value="<%= order %>">

        <button type="submit" class="bubble btn-apply">Apply</button>
      </form>
    </div>

    <% if (appointments.length === 0) { %>
      <div class="no-data">
        <p>No appointments found. Try adjusting your search or add a new one.</p>
      </div>
    <% } else { %>

      <!-- TABLE -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>
                <a class="table-sort <%= sort === 'date' ? 'active ' + order : '' %>" href="<%= sortUrl('date') %>">
                  Date <span class="arrow">&#9650;</span>
                </a>
              </th>
              <th>Patient</th>
              <th>Physician</th>
              <th>Summary</th>
              <th>
                <a class="table-sort <%= sort === 'diagnosis' ? 'active ' + order : '' %>" href="<%= sortUrl('diagnosis') %>">
                  Diagnosis <span class="arrow">&#9650;</span>
                </a>
              </th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="appointments-table-body">
            <%- include("partials/appointment-row", { appointments, apptsCanEdit }) %>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <div id="pagination-container">
        <%- renderPagination(req, "/appointments", page, totalPages) %>
      </div>

      <p class="record-count" id="result-count">
        Showing <%= appointments.length %> of <%= totalCount %> appointment<%= totalCount !== 1 ? "s" : "" %>
      </p>

    <% } %>

  </div>

  <!-- NOTES MODAL -->
  <div id="notesModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">A-</span>
      <h3>Clinical Notes</h3>
      <div id="notesContent" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></div>
    </div>
  </div>

  <script>
    function showNotes(button) {
      const notes = button.dataset.notes || "No notes recorded.";
      document.getElementById("notesContent").textContent = notes;
      document.getElementById("notesModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("notesModal").style.display = "none";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("notesModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    }

  </script>
  <script src="/js/table-ajax.js"></script>

  <style>
    .table-sort,
    .table-sort:visited {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 1000;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover { text-decoration: underline; }
    .table-sort.active .arrow { opacity: 1; }
    .table-sort.active.desc .arrow { transform: rotate(180deg); }
  </style>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>
</body>
</html>
