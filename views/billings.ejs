<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Billings - Medical DB</title>

  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="/smart-search.css">
  <script defer src="/js/table-ajax.js"></script>
</head>

<body>

  <!-- NAVBAR -->
  <%- include("partials/navbar", { activePage: "billings" }) %>

  <div class="container">

    <!-- HEADER -->
    <div class="page-header">
      <h2>Billings</h2>
      <a href="/" class="btn btn-secondary">Back Home</a>
    </div>

    <!-- ======== TOTALS BAR (Modern stat cards) ======== -->
    <div class="stats-row">
      <div class="stat-box">
        <h4>Total Amount</h4>
        <div class="stat-value">$<%= Number(totals.totalAmount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
      </div>

      <div class="stat-box">
        <h4>Paid</h4>
        <div class="stat-value">$<%= Number(totals.totalPaid || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
      </div>

      <div class="stat-box">
        <h4>Pending</h4>
        <div class="stat-value">$<%= Number(totals.totalPending || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
      </div>

      <div class="stat-box">
        <h4>Due</h4>
        <div class="stat-value">$<%= Number(totals.totalDue || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
      </div>
    </div>

    <!-- =============== MODERN SEARCHBAR =============== -->
    <div class="searchbar-wrapper">
      <form id="filter-form" class="searchbar-modern" method="GET">

        <input 
          type="text"
          name="search"
          placeholder="Search billings..."
          value="<%= search %>"
          autocomplete="off"
          class="searchbar-main"
        >

        <input type="hidden" name="sort" id="sort-hidden" value="<%= sort %>">
        <input type="hidden" name="order" id="order-hidden" value="<%= order || 'desc' %>">
        <select name="status" class="bubble">
          <option value="">Status</option>
          <option value="Paid" <%= status === "Paid" ? "selected" : "" %>>Paid</option>
          <option value="Pending" <%= status === "Pending" ? "selected" : "" %>>Pending</option>
          <option value="Due" <%= status === "Due" ? "selected" : "" %>>Due</option>
        </select>

        <button type="submit" class="bubble btn-apply">Apply</button>
      </form>
    </div>

    <% if (billings.length === 0) { %>
      <div class="no-data">
        <p>No billing records found. Try adjusting search or filters.</p>
      </div>
    <% } else { %>

      <!-- TABLE -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Patient</th>
              <th>
                <button type="button" class="table-sort <%= sort === 'status' ? 'active ' + order : '' %>" data-sort="status">
                  Status <span class="arrow">▲</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'amount' ? 'active ' + order : '' %>" data-sort="amount">
                  Amount <span class="arrow">▲</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'createdAt' ? 'active ' + order : '' %>" data-sort="createdAt">
                  Date Issued <span class="arrow">▲</span>
                </button>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="billings-table-body">
            <%- include("partials/billing-row", { billings, billingsCanEdit }) %>
          </tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <div id="pagination-container">
        <%- renderPagination(req, "/billings", page, totalPages) %>
      </div>

      <p class="record-count" id="result-count">
        Showing <%= billings.length %> of <%= totalCount %> billing record<%= totalCount !== 1 ? "s" : "" %>.
      </p>

    <% } %>

  </div>

  <script src="/js/table-ajax.js"></script>
  <script>
    // Column sorting
    (function() {
      const sortButtons = document.querySelectorAll(".table-sort");
      const sortHidden = document.getElementById("sort-hidden");
      const orderHidden = document.getElementById("order-hidden");
      const filterForm = document.getElementById("filter-form");
      function applySortState() {
        sortButtons.forEach(btn => {
          const active = btn.dataset.sort === sortHidden.value;
          btn.classList.toggle("active", active);
          btn.classList.toggle("asc", active && orderHidden.value === "asc");
          btn.classList.toggle("desc", active && orderHidden.value === "desc");
        });
      }
      applySortState();
      sortButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const field = btn.dataset.sort;
          if (sortHidden.value === field) {
            orderHidden.value = orderHidden.value === "asc" ? "desc" : "asc";
          } else {
            sortHidden.value = field;
            orderHidden.value = field === "amount" ? "desc" : "asc";
          }
          applySortState();
          filterForm.dispatchEvent(new Event("change", { bubbles: true }));
        });
      });
    })();
  </script>
  <style>
    .table-sort {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 700;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover { text-decoration: underline; }
    .table-sort.active .arrow { opacity: 1; }
    .table-sort.active.desc .arrow { transform: rotate(180deg); }
  </style>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>

</body>
</html>
