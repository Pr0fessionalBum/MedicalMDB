<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prescriptions - Medical DB</title>

  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/smart-search.css" />
  <script defer src="/js/table-ajax.js"></script>
</head>

<body>

  <!-- NAVBAR -->
  <%- include("partials/navbar", { activePage: "prescriptions" }) %>

  <div class="container">

    <!-- PAGE HEADER -->
    <div class="page-header">
      <h2>Prescriptions</h2>
      <a href="/" class="btn btn-secondary">Back Home</a>
    </div>

    <!-- FILTER BAR -->
    <div class="searchbar-wrapper">
      <form id="filter-form" class="searchbar-modern" method="GET">

        <input
          id="search-input"
          type="text"
          name="search"
          placeholder="Search prescriptions..."
          value="<%= search %>"
          autocomplete="off"
          class="searchbar-main"
        >

        <select id="type-filter" name="type" class="bubble">
          <option value="">Type</option>
          <option value="chronic" <%= type === "chronic" ? "selected" : "" %>>Chronic</option>
        </select>

        <select id="status-filter" name="status" class="bubble">
          <option value="">Status</option>
          <option value="active" <%= status === "active" ? "selected" : "" %>>Active</option>
          <option value="completed" <%= status === "completed" ? "selected" : "" %>>Completed</option>
        </select>

        <input type="hidden" name="sort" id="sort-hidden" value="<%= sort %>">
        <input type="hidden" name="order" id="order-hidden" value("<%= order %>">

        <button type="submit" class="bubble btn-apply">Apply</button>
        <button type="reset" class="bubble btn-reset" onclick="window.location.href='/prescriptions'">Reset</button>

      </form>
    </div>

    <% if (prescriptions.length === 0) { %>
      <div class="no-data"><p>No prescriptions found.</p></div>

    <% } else { %>

      <!-- TABLE -->
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>
                <button type="button" class="table-sort <%= sort === 'patient' ? 'active ' + order : '' %>" data-sort="patient">
                  Patient <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'medicationName' ? 'active ' + order : '' %>" data-sort="medicationName">
                  Medication <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'dosage' ? 'active ' + order : '' %>" data-sort="dosage">
                  Dosage <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'frequency' ? 'active ' + order : '' %>" data-sort="frequency">
                  Frequency <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'type' ? 'active ' + order : '' %>" data-sort="type">
                  Type <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'status' ? 'active ' + order : '' %>" data-sort="status">
                  Status <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'startDate' ? 'active ' + order : '' %>" data-sort="startDate">
                  Start Date <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>
                <button type="button" class="table-sort <%= sort === 'endDate' ? 'active ' + order : '' %>" data-sort="endDate">
                  End Date <span class="arrow">&#9650;</span>
                </button>
              </th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="prescriptions-table-body">
            <% prescriptions.forEach(rx => { %>
              <%- include("partials/prescription-row", { rx }) %>
            <% }) %>
          </tbody>

        </table>
      </div>

      <!-- PAGINATION -->
      <div id="pagination-container">
        <%- renderPagination(req, "/prescriptions", page, totalPages) %>
      </div>

      <!-- COUNT -->
      <p class="record-count" id="result-count">
        Showing <%= prescriptions.length %> of <%= totalCount %> prescription<%= totalCount !== 1 ? "s" : "" %>
      </p>

    <% } %>

  </div>

  <script>
    const sortButtons = document.querySelectorAll(".table-sort");
    const sortHidden = document.getElementById("sort-hidden");
    const orderHidden = document.getElementById("order-hidden");
    const filterForm = document.getElementById("filter-form");

    function applySortState() {
      sortButtons.forEach(btn => {
        const isActive = btn.dataset.sort === sortHidden.value;
        btn.classList.toggle("active", isActive);
        btn.classList.toggle("asc", isActive && orderHidden.value === "asc");
        btn.classList.toggle("desc", isActive && orderHidden.value === "desc");
      });
    }
    applySortState();

    sortButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const field = btn.dataset.sort;
        if (sortHidden.value === field) {
          orderHidden.value = orderHidden.value === "asc" ? "desc" : "asc";
        } else {
          sortHidden.value = field;
          orderHidden.value = field === "medicationName" ? "asc" : "desc";
        }
        applySortState();
        // AJAX change event (table-ajax.js will intercept); prevent double submits
        filterForm.dispatchEvent(new Event("change", { bubbles: true }));
      });
    });
  </script>

  <style>
    .table-sort,
    .table-sort:visited {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      font: inherit;
      font-weight: 800;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      min-width: 90px;
    }
    .table-sort .arrow {
      font-size: 10px;
      width: 10px;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.4;
    }
    .table-sort:hover {
      text-decoration: underline;
    }
    .table-sort.active .arrow {
      opacity: 1;
    }
    .table-sort.active.desc .arrow {
      transform: rotate(180deg);
    }
  </style>

</body>
</html>
