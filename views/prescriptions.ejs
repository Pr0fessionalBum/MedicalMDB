<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prescriptions - Medical DB</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <h1 class="logo">üè• Medical DB</h1>
      <ul class="nav-links">
        <li><a href="/patients">Patients</a></li>
        <li><a href="/physicians">Physicians</a></li>
        <li><a href="/prescriptions" class="active">Prescriptions</a></li>
        <li><a href="/appointments">Appointments</a></li>
        <li><a href="/billings">Billings</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h2>Prescriptions</h2>
      <div>
        <a href="/prescriptions/create" class="btn btn-primary">+ Add Prescription</a>
        <a href="/" class="btn btn-secondary">Back Home</a>
      </div>
    </div>

    <div class="controls">
      <form method="GET" class="search-form" id="prescription-search-form">
        <input 
          type="text" 
          name="search" 
          placeholder="Search by medication, dosage, instructions..." 
          value="<%= search %>" 
          class="search-input"
        >
        <select name="status" class="filter-select" style="margin-left:8px;" onchange="this.form.submit()">
          <option value="">All Statuses</option>
          <option value="active" <%= status === 'active' ? 'selected' : '' %>>Active</option>
          <option value="completed" <%= status === 'completed' ? 'selected' : '' %>>Completed</option>
          <option value="discontinued" <%= status === 'discontinued' ? 'selected' : '' %>>Discontinued</option>
          <option value="pending" <%= status === 'pending' ? 'selected' : '' %>>Pending</option>
        </select>
        <select name="type" class="filter-select" style="margin-left:8px;" onchange="this.form.submit()">
          <option value="">All Types</option>
          <option value="Tablet" <%= type === 'Tablet' ? 'selected' : '' %>>Tablet</option>
          <option value="Injection" <%= type === 'Injection' ? 'selected' : '' %>>Injection</option>
          <option value="Liquid" <%= type === 'Liquid' ? 'selected' : '' %>>Liquid</option>
          <option value="Other" <%= type === 'Other' ? 'selected' : '' %>>Other</option>
        </select>
        <select name="sort" class="sort-select" style="margin-left:8px;" onchange="this.form.submit()">
          <option value="medicationName" <%= sort === 'medicationName' ? 'selected' : '' %>>Sort by Medication</option>
          <option value="status" <%= sort === 'status' ? 'selected' : '' %>>Sort by Status</option>
          <option value="date" <%= sort === 'date' ? 'selected' : '' %>>Sort by Start Date</option>
        </select>
        <button type="submit" class="btn btn-primary" style="margin-left:8px;">Search</button>
      </form>
    </div>

    <% if (prescriptions.length === 0) { %>
      <div class="no-data">
        <p>No prescriptions found.</p>
      </div>
    <% } else { %>
      <div class="table-wrapper" id="prescriptions-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Patient</th>
              <th>Medication</th>
              <th>Dosage</th>
              <th>Frequency</th>
              <th>Type</th>
              <th>Status</th>
              <th>Start Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="prescriptions-table-body">
            <% prescriptions.forEach(rx => { %>
              <tr>
                <td><a href="/patients/<%= rx.patientID._id %>"><%= rx.patientID.name %></a></td>
                <td><strong><%= rx.medicationName %></strong></td>
                <td><%= rx.dosage %></td>
                <td><%= rx.frequency || 'N/A' %></td>
                <td><%= rx.type || 'N/A' %></td>
                <td><span class="badge badge-<%= rx.status %>"><%= rx.status %></span></td>
                <td><%= rx.startDate ? new Date(rx.startDate).toLocaleDateString() : '' %></td>
                <td>
                  <form method="POST" action="/prescriptions/<%= rx._id %>/delete" style="display:inline; margin: 0;">
                    <button type="submit" class="btn btn-small" style="background-color: #dc2626; font-size: 11px;" onclick="return confirm('Delete this prescription?')">Delete</button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <div class="pagination-controls">
        <% if (totalPages > 1) { %>
          <%- renderPagination(page, totalPages) %>
        <% } %>
      </div>
      <p class="record-count">Showing <%= prescriptions.length %> of <%= totalCount %> prescription<%= totalCount !== 1 ? 's' : '' %></p>
      <!-- Per-page dropdown at bottom (only one instance) -->
      <div class="perpage-controls" style="margin-top:8px; text-align:right; font-size:12px;">
        <label for="page-size" style="margin-right:4px;">Per page:</label>
        <select id="page-size" name="limit" style="font-size:12px; padding:2px 6px;" onchange="window.location.href='/prescriptions?<%= paginationQuery(page) %>&limit='+this.value">
          <option value="10" <%= limit == 10 ? 'selected' : '' %>>10</option>
          <option value="25" <%= limit == 25 ? 'selected' : '' %>>25</option>
          <option value="50" <%= limit == 50 ? 'selected' : '' %>>50</option>
          <option value="100" <%= limit == 100 ? 'selected' : '' %>>100</option>
        </select>
      </div>
  <script>
    // AJAX live update logic for prescriptions
    document.getElementById('prescription-search-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const params = new URLSearchParams(new FormData(form));
      params.append('ajax', '1');
      fetch('/prescriptions?' + params.toString())
        .then(res => res.json())
        .then(data => {
          document.getElementById('prescriptions-table-body').innerHTML = data.rowsHtml;
          document.querySelector('.record-count').textContent = `Showing ${data.count} of ${data.totalCount} prescriptions`;
          document.querySelector('.pagination-controls').innerHTML = data.paginationHtml;
        });
    });
  </script>
    <% } %>
  </div>

  <footer>
    <p>&copy; 2025 Medical Database Management System</p>
  </footer>
</body>
</html>
